#!/usr/bin/env node

// Dependencies
var Logger = require("bug-killer")
  , CLP = require("clp")
  , Path = require("path")
  , Package = require("../package")
  , BloggifyServer = require("../lib/server")
  , IsThere = require("is-there")
  ;

// Create the arguments parser
var parser = new CLP({
    name: "Bloggify"
  , version: Package.version
  , exe: Package.name
  , examples: [
        "bloggify -c path/to/some-site"
      , "bloggify -h"
    ]
  , docs_url: "https://github.com/Bloggify/Bloggify"
});


// Config option
var configOption = new CLP.Option(["config", "c"], "The path to the config file or site directory.", "config")
parser.addOption(configOption);
parser.process();

// Check the config option
if (!configOption.value) {
    return Logger.log("Please provide a path to the config file.", "error");
} else {
    configOption.value = Path.resolve(process.cwd(), configOption.value);
}

// Normalize the path to the configuration file
var confPath = configOption.value;
if (!/\.json$/.test(confPath)) {
    confPath = confPath + "/conf/index.json";
}

// Check the configuration file path
if (!IsThere(confPath)) {
    return Logger.log("The configuration file was not found.", "error");
}

// Start the Bloggify server
BloggifyServer.start(confPath, function (message) {
    Bloggify.log(message, "info");
}, function (err, data) {
    if (err) {
        return Bloggify.log(err, "error");
    }
    Bloggify.log(data, "info");
});
